<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login & Register - Spartan Corporation Studio</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="icon" href="https://res.cloudinary.com/dqrp70g9u/image/upload/v1765560274/Music_Player-removebg-preview_t5iv3j.png">
    <style>
        .auth-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 50%, #2d2d2d 100%);
            padding: 20px;
        }
        
        .auth-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 40px;
            width: 100%;
            max-width: 450px;
            backdrop-filter: blur(20px);
        }
        
        .auth-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .auth-logo {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            border-radius: 15px;
        }
        
        .auth-title {
            font-size: 2rem;
            font-weight: 700;
            color: #ffffff;
            margin-bottom: 10px;
        }
        
        .auth-subtitle {
            color: #cccccc;
            font-size: 1rem;
        }
        
        .auth-tabs {
            display: flex;
            margin-bottom: 30px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 4px;
            gap: 2px;
        }
        
        .auth-tab {
            flex: 1;
            padding: 10px 8px;
            background: none;
            border: none;
            color: #888888;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.85rem;
            text-align: center;
        }
        
        .auth-tab.active {
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
        }
        
        .auth-form {
            display: none;
        }
        
        .auth-form.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            color: #ffffff;
            font-weight: 500;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }
        
        .form-input {
            width: 100%;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            color: #ffffff;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            background: rgba(255, 255, 255, 0.15);
        }
        
        .form-input::placeholder {
            color: #888888;
        }
        
        .auth-submit-btn {
            width: 100%;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: #ffffff;
            font-weight: 600;
            font-size: 1rem;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }
        
        .auth-submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }
        
        .auth-submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .auth-divider {
            text-align: center;
            margin: 25px 0;
            position: relative;
            color: #888888;
        }
        
        .auth-divider::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: rgba(255, 255, 255, 0.1);
        }
        
        .auth-divider span {
            background: rgba(255, 255, 255, 0.05);
            padding: 0 15px;
            position: relative;
        }
        
        .auth-footer {
            text-align: center;
            margin-top: 25px;
        }
        
        .auth-link {
            color: #667eea;
            text-decoration: none;
            font-weight: 500;
        }
        
        .auth-link:hover {
            text-decoration: underline;
        }
        
        .success-message {
            background: rgba(46, 213, 115, 0.2);
            border: 1px solid rgba(46, 213, 115, 0.3);
            color: #2ed573;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .error-message {
            background: rgba(255, 71, 87, 0.2);
            border: 1px solid rgba(255, 71, 87, 0.3);
            color: #ff4757;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .user-id-display {
            background: rgba(102, 126, 234, 0.2);
            border: 1px solid rgba(102, 126, 234, 0.3);
            color: #667eea;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin: 20px 0;
        }
        
        .user-id-display h3 {
            margin-bottom: 10px;
            color: #ffffff;
        }
        
        .user-id-code {
            font-family: 'Courier New', monospace;
            font-size: 1.2rem;
            font-weight: 700;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            word-break: break-all;
        }
        
        .copy-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #ffffff;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            margin-top: 10px;
        }
        
        .loading-spinner {
            display: none;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid #ffffff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        .progress-indicator {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }
        
        .progress-step {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #888888;
            font-size: 0.85rem;
        }
        
        .progress-step.active {
            color: #667eea;
        }
        
        .progress-step.completed {
            color: #2ed573;
        }
        
        .step-number {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .progress-step.active .step-number {
            background: #667eea;
            color: #ffffff;
        }
        
        .progress-step.completed .step-number {
            background: #2ed573;
            color: #ffffff;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .password-requirements {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .requirement {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #ff4757;
            transition: color 0.3s ease;
        }
        
        .requirement.valid {
            color: #2ed573;
        }
        
        .req-icon {
            font-weight: bold;
            font-size: 0.9rem;
        }
        
        .requirement.valid .req-icon {
            color: #2ed573;
        }
        
        .requirement.valid .req-icon::before {
            content: '‚úì';
        }
        
        .requirement:not(.valid) .req-icon::before {
            content: '‚úó';
        }

    </style>
</head>
<body>
    <div class="auth-container">
        <div class="auth-card">
            <div class="auth-header">
                <img src="https://res.cloudinary.com/dqrp70g9u/image/upload/v1765560274/Music_Player-removebg-preview_t5iv3j.png" alt="Spartan Studio Logo" class="auth-logo">
                <h1 class="auth-title">Welcome Back</h1>
                <p class="auth-subtitle">Login or create your account</p>
            </div>

            <!-- Success/Error Messages -->
            <div id="messageContainer"></div>

            <!-- Auth Tabs -->
            <div class="auth-tabs">
                <button class="auth-tab active" data-tab="login">Login</button>
                <button class="auth-tab" data-tab="register">Register</button>
                <button class="auth-tab" data-tab="forgot">Reset Password</button>
            </div>

            <!-- Login Form -->
            <div class="auth-form active" id="loginForm">
                <div class="form-group">
                    <label class="form-label">User ID</label>
                    <input type="text" class="form-input" id="loginUserId" placeholder="Enter your User ID" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" class="form-input" id="loginPassword" placeholder="Enter your password" required>
                </div>
                <button class="auth-submit-btn" id="loginBtn">
                    <span id="loginBtnText">Login</span>
                    <div class="loading-spinner" id="loginSpinner"></div>
                </button>
                
                <div class="auth-footer" style="margin-top: 15px;">
                    <a href="#" class="auth-link" onclick="switchToTab('forgot')">Forgot Password?</a>
                </div>
            </div>

            <!-- Register Form -->
            <div class="auth-form" id="registerForm">
                <div class="form-group">
                    <label class="form-label">Username</label>
                    <input type="text" class="form-input" id="registerUsername" placeholder="Choose a username" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Roblox Username</label>
                    <input type="text" class="form-input" id="registerRobloxName" placeholder="Your Roblox username" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" class="form-input" id="registerPassword" placeholder="Create a password" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Confirm Password</label>
                    <input type="password" class="form-input" id="confirmPassword" placeholder="Confirm your password" required>
                </div>
                <button class="auth-submit-btn" id="registerBtn">
                    <span id="registerBtnText">Register</span>
                    <div class="loading-spinner" id="registerSpinner"></div>
                </button>
            </div>

            <!-- Forgot Password Form -->
            <div class="auth-form" id="forgotForm">
                <div class="progress-indicator">
                    <div class="progress-step active">
                        <div class="step-number">1</div>
                        <span>Verify Identity</span>
                    </div>
                    <div style="width: 30px; height: 2px; background: rgba(255, 255, 255, 0.2);"></div>
                    <div class="progress-step">
                        <div class="step-number">2</div>
                        <span>Set New Password</span>
                    </div>
                </div>
                
                <div style="background: rgba(102, 126, 234, 0.1); border: 1px solid rgba(102, 126, 234, 0.3); border-radius: 10px; padding: 15px; margin-bottom: 20px;">
                    <h4 style="color: #667eea; margin-bottom: 8px; font-size: 0.9rem;">Password Recovery</h4>
                    <p style="color: #cccccc; font-size: 0.85rem; line-height: 1.4; margin: 0;">
                        Enter your User ID and Roblox username to verify your identity. We'll then allow you to set a new password.
                    </p>
                </div>
                
                <div class="form-group">
                    <label class="form-label">User ID</label>
                    <input type="text" class="form-input" id="forgotUserId" placeholder="Enter your User ID" required>
                    <small style="color: #888888; font-size: 0.8rem;">This is the ID you received when you registered</small>
                </div>
                <div class="form-group">
                    <label class="form-label">Roblox Username</label>
                    <input type="text" class="form-input" id="forgotRobloxName" placeholder="Enter your Roblox username for verification" required>
                    <small style="color: #888888; font-size: 0.8rem;">Must match the username you used during registration</small>
                </div>
                <button class="auth-submit-btn" id="forgotBtn">
                    <span id="forgotBtnText">Verify & Reset Password</span>
                    <div class="loading-spinner" id="forgotSpinner"></div>
                </button>
                
                <div style="margin-top: 20px; padding: 12px; background: rgba(255, 193, 7, 0.1); border: 1px solid rgba(255, 193, 7, 0.3); border-radius: 8px;">
                    <h5 style="color: #ffc107; margin-bottom: 8px; font-size: 0.85rem;">üõ°Ô∏è Security Tips</h5>
                    <ul style="color: #cccccc; font-size: 0.8rem; margin: 0; padding-left: 15px; line-height: 1.4;">
                        <li>Never share your User ID or password with anyone</li>
                        <li>Use a unique password for your account</li>
                        <li>Keep your Roblox username information secure</li>
                    </ul>
                </div>
                
                <div class="auth-footer" style="margin-top: 15px;">
                    <a href="#" class="auth-link" onclick="switchToTab('login')">Back to Login</a>
                </div>
            </div>

            <!-- Reset Password Form -->
            <div class="auth-form" id="resetForm">
                <div class="progress-indicator">
                    <div class="progress-step completed">
                        <div class="step-number">‚úì</div>
                        <span>Verify Identity</span>
                    </div>
                    <div style="width: 30px; height: 2px; background: #2ed573;"></div>
                    <div class="progress-step active">
                        <div class="step-number">2</div>
                        <span>Set New Password</span>
                    </div>
                </div>
                
                <div style="background: rgba(46, 213, 115, 0.1); border: 1px solid rgba(46, 213, 115, 0.3); border-radius: 10px; padding: 15px; margin-bottom: 20px;">
                    <h4 style="color: #2ed573; margin-bottom: 8px; font-size: 0.9rem;">Set New Password</h4>
                    <p style="color: #cccccc; font-size: 0.85rem; line-height: 1.4; margin: 0;">
                        Your identity has been verified. Please create a strong new password.
                    </p>
                    <div id="sessionTimer" style="margin-top: 10px; color: #ffc107; font-size: 0.8rem; text-align: center;">
                        Session expires in: <span id="timeLeft">15:00</span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">New Password</label>
                    <input type="password" class="form-input" id="newPassword" placeholder="Enter new password" required>
                    <div class="password-requirements" style="margin-top: 8px; font-size: 0.8rem;">
                        <div class="requirement" id="req-length">
                            <span class="req-icon">‚úó</span> At least 6 characters
                        </div>
                        <div class="requirement" id="req-upper">
                            <span class="req-icon">‚úó</span> One uppercase letter
                        </div>
                        <div class="requirement" id="req-lower">
                            <span class="req-icon">‚úó</span> One lowercase letter
                        </div>
                        <div class="requirement" id="req-number">
                            <span class="req-icon">‚úó</span> One number
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Confirm New Password</label>
                    <input type="password" class="form-input" id="confirmNewPassword" placeholder="Confirm new password" required>
                    <div class="requirement" id="req-match" style="margin-top: 8px; font-size: 0.8rem;">
                        <span class="req-icon">‚úó</span> Passwords match
                    </div>
                </div>
                <button class="auth-submit-btn" id="resetBtn">
                    <span id="resetBtnText">Update Password</span>
                    <div class="loading-spinner" id="resetSpinner"></div>
                </button>
                
                <div class="auth-footer" style="margin-top: 15px;">
                    <a href="#" class="auth-link" onclick="switchToTab('login')">Back to Login</a>
                </div>
            </div>

            <div class="auth-footer">
                <p style="color: #888888; font-size: 0.9rem;">
                    Need help? <a href="faq.html" class="auth-link">Visit FAQ</a>
                </p>
                <div style="margin-top: 15px; padding: 10px; background: rgba(255, 193, 7, 0.1); border: 1px solid rgba(255, 193, 7, 0.3); border-radius: 8px;">
                    <p style="color: #ffc107; font-size: 0.8rem; margin: 0; text-align: center;">
                        üîí Your password is encrypted and secure. We never store passwords in plain text.
                    </p>
                </div>
                <div style="margin-top: 10px; text-align: center;">
                    <p style="color: #888888; font-size: 0.75rem; margin: 0;">
                        Having trouble? Contact support or check our <a href="faq.html" class="auth-link">FAQ</a>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <script src="script.js"></script>
    <script>
        // Use Firebase from global scope (initialized in script.js)
        // Firebase is already initialized in script.js

        // Auth System Functions
        async function authenticateUser(userId, password) {
            try {
                const userDoc = await db.collection('users').doc(userId).get();
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    if (userData.password === password) {
                        return { id: userId, ...userData };
                    }
                }
                return null;
            } catch (error) {
                console.error('Auth error:', error);
                return null;
            }
        }
        
        async function registerUser(username, robloxName, password) {
            try {
                const userId = Date.now().toString() + Math.random().toString(36).substring(2, 7);
                const newUser = {
                    username: username,
                    robloxName: robloxName,
                    password: password,
                    role: 'user',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await db.collection('users').doc(userId).set(newUser);
                return { id: userId, ...newUser };
            } catch (error) {
                console.error('Registration error:', error);
                throw error;
            }
        }
        
        // Tab switching
        document.querySelectorAll('.auth-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const targetTab = tab.getAttribute('data-tab');
                switchToTab(targetTab);
            });
        });

        function switchToTab(targetTab) {
            // Clear any existing timers
            clearResetSessionTimer();
            
            // Remove active class from all tabs and forms
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
            
            // Add active class to clicked tab and corresponding form
            const targetTabElement = document.querySelector(`[data-tab="${targetTab}"]`);
            if (targetTabElement) {
                targetTabElement.classList.add('active');
            }
            
            const targetForm = document.getElementById(targetTab + 'Form');
            if (targetForm) {
                targetForm.classList.add('active');
            }
            
            // Clear messages
            clearMessages();
            
            // Clear form fields when switching tabs
            clearFormFields(targetTab);
            
            // Update title based on tab
            const titles = {
                login: 'Welcome Back',
                register: 'Create Account',
                forgot: 'Reset Password',
                reset: 'Set New Password'
            };
            const titleElement = document.querySelector('.auth-title');
            if (titleElement) {
                titleElement.textContent = titles[targetTab] || 'Welcome Back';
            }
            
            // Auto-focus first input
            setTimeout(() => {
                const firstInput = document.querySelector(`#${targetTab}Form .form-input`);
                if (firstInput) {
                    firstInput.focus();
                }
            }, 100);
            
            // Start session timer for reset form
            if (targetTab === 'reset') {
                startResetSessionTimer();
            }
        }
        
        function clearFormFields(targetTab) {
            const forms = {
                login: ['loginUserId', 'loginPassword'],
                register: ['registerUsername', 'registerRobloxName', 'registerPassword', 'confirmPassword'],
                forgot: ['forgotUserId', 'forgotRobloxName'],
                reset: ['newPassword', 'confirmNewPassword']
            };
            
            if (forms[targetTab]) {
                forms[targetTab].forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (field) {
                        field.value = '';
                    }
                });
            }
            
            // Clear password requirements validation
            if (targetTab === 'reset') {
                document.querySelectorAll('.requirement').forEach(req => {
                    req.classList.remove('valid');
                });
            }
        }

        // Login functionality
        document.getElementById('loginBtn').addEventListener('click', async function() {
            const userId = document.getElementById('loginUserId').value.trim();
            const password = document.getElementById('loginPassword').value.trim();
            
            if (!userId || !password) {
                showMessage('Please fill in all fields', 'error');
                return;
            }
            
            setLoading('login', true);
            
            try {
                // User login with Firebase
                const user = await authenticateUser(userId, password);
                
                if (user) {
                    // Store user session
                    const userSession = {
                        id: user.id,
                        username: user.username,
                        robloxName: user.robloxName,
                        role: user.role,
                        timestamp: Date.now()
                    };
                    localStorage.setItem('spartanUserSession', JSON.stringify(userSession));
                    
                    showMessage('Login successful! Redirecting...', 'success');
                    
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 1500);
                } else {
                    showMessage('Invalid User ID or password', 'error');
                }
            } catch (error) {
                console.error('Login error:', error);
                showMessage('Login failed. Please try again.', 'error');
            }
            
            setLoading('login', false);
        });

        // Register functionality
        document.getElementById('registerBtn').addEventListener('click', async function() {
            const username = document.getElementById('registerUsername').value.trim();
            const robloxName = document.getElementById('registerRobloxName').value.trim();
            const password = document.getElementById('registerPassword').value.trim();
            const confirmPassword = document.getElementById('confirmPassword').value.trim();
            
            if (!username || !robloxName || !password || !confirmPassword) {
                showMessage('Please fill in all fields', 'error');
                return;
            }
            
            if (password !== confirmPassword) {
                showMessage('Passwords do not match', 'error');
                return;
            }
            
            if (password.length < 6) {
                showMessage('Password must be at least 6 characters long', 'error');
                return;
            }
            
            setLoading('register', true);
            
            try {
                // Register user with Firebase
                const newUser = await registerUser(username, robloxName, password);
                
                // Show success message with user ID
                showUserIdSuccess(newUser.id);
                
                // Clear form fields
                document.getElementById('registerUsername').value = '';
                document.getElementById('registerRobloxName').value = '';
                document.getElementById('registerPassword').value = '';
                document.getElementById('confirmPassword').value = '';
                
            } catch (error) {
                console.error('Registration error:', error);
                showMessage('Registration failed. Please try again.', 'error');
            }
            
            setLoading('register', false);
        });

        // Rate limiting for password reset attempts
        let resetAttempts = parseInt(localStorage.getItem('resetAttempts') || '0');
        let lastResetAttempt = parseInt(localStorage.getItem('lastResetAttempt') || '0');
        
        function checkRateLimit() {
            const now = Date.now();
            const oneHour = 60 * 60 * 1000;
            
            // Reset attempts if more than 1 hour has passed
            if (now - lastResetAttempt > oneHour) {
                resetAttempts = 0;
                localStorage.setItem('resetAttempts', '0');
            }
            
            // Allow max 3 attempts per hour
            if (resetAttempts >= 3) {
                const timeLeft = Math.ceil((oneHour - (now - lastResetAttempt)) / (60 * 1000));
                showMessage(`Too many reset attempts. Please try again in ${timeLeft} minutes.`, 'error');
                return false;
            }
            
            return true;
        }
        
        function recordResetAttempt() {
            resetAttempts++;
            const now = Date.now();
            localStorage.setItem('resetAttempts', resetAttempts.toString());
            localStorage.setItem('lastResetAttempt', now.toString());
        }

        // Forgot Password functionality
        document.getElementById('forgotBtn').addEventListener('click', async function() {
            const userId = document.getElementById('forgotUserId').value.trim();
            const robloxName = document.getElementById('forgotRobloxName').value.trim();
            
            if (!userId || !robloxName) {
                showMessage('Please fill in all fields', 'error');
                return;
            }
            
            // Check rate limit
            if (!checkRateLimit()) {
                return;
            }
            
            setLoading('forgot', true);
            
            try {
                // Verify user exists and Roblox name matches
                const userDoc = await db.collection('users').doc(userId).get();
                
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    if (userData.robloxName.toLowerCase() === robloxName.toLowerCase()) {
                        // Store user ID and verification token for password reset
                        const resetToken = Date.now().toString() + Math.random().toString(36).substring(2, 7);
                        sessionStorage.setItem('resetUserId', userId);
                        sessionStorage.setItem('resetToken', resetToken);
                        sessionStorage.setItem('resetTokenTime', Date.now().toString());
                        
                        // Log password reset attempt
                        try {
                            await db.collection('passwordResets').add({
                                userId: userId,
                                robloxName: robloxName,
                                resetToken: resetToken,
                                action: 'verification_successful',
                                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                                ipAddress: 'unknown', // In real app, you'd get actual IP
                                userAgent: navigator.userAgent,
                                success: true
                            });
                        } catch (logError) {
                            console.log('Failed to log reset attempt:', logError);
                        }
                        
                        showMessage('‚úÖ Verification successful! You can now set a new password.', 'success');
                        
                        setTimeout(() => {
                            switchToTab('reset');
                        }, 1500);
                    } else {
                        recordResetAttempt();
                        showMessage('Roblox username does not match our records', 'error');
                    }
                } else {
                    recordResetAttempt();
                    showMessage('User ID not found', 'error');
                }
            } catch (error) {
                console.error('Forgot password error:', error);
                recordResetAttempt();
                showMessage('Verification failed. Please try again.', 'error');
            }
            
            setLoading('forgot', false);
        });

        // Reset Password functionality
        document.getElementById('resetBtn').addEventListener('click', async function() {
            const newPassword = document.getElementById('newPassword').value.trim();
            const confirmNewPassword = document.getElementById('confirmNewPassword').value.trim();
            const userId = sessionStorage.getItem('resetUserId');
            const resetToken = sessionStorage.getItem('resetToken');
            const resetTokenTime = parseInt(sessionStorage.getItem('resetTokenTime') || '0');
            
            // Check if session is valid (token expires after 15 minutes)
            const fifteenMinutes = 15 * 60 * 1000;
            if (!userId || !resetToken || (Date.now() - resetTokenTime) > fifteenMinutes) {
                showMessage('Reset session expired. Please verify your identity again.', 'error');
                sessionStorage.removeItem('resetUserId');
                sessionStorage.removeItem('resetToken');
                sessionStorage.removeItem('resetTokenTime');
                switchToTab('forgot');
                return;
            }
            
            if (!newPassword || !confirmNewPassword) {
                showMessage('Please fill in all fields', 'error');
                return;
            }
            
            if (newPassword !== confirmNewPassword) {
                showMessage('Passwords do not match', 'error');
                return;
            }
            
            if (newPassword.length < 6) {
                showMessage('Password must be at least 6 characters long', 'error');
                return;
            }
            
            // Check password strength
            const hasUpperCase = /[A-Z]/.test(newPassword);
            const hasLowerCase = /[a-z]/.test(newPassword);
            const hasNumbers = /\d/.test(newPassword);
            
            if (!hasUpperCase || !hasLowerCase || !hasNumbers) {
                showMessage('Password must contain at least one uppercase letter, one lowercase letter, and one number', 'error');
                return;
            }
            
            setLoading('reset', true);
            
            try {
                // Update password in Firebase
                await db.collection('users').doc(userId).update({
                    password: newPassword,
                    passwordUpdatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastPasswordReset: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Log successful password reset
                try {
                    await db.collection('passwordResets').add({
                        userId: userId,
                        action: 'password_updated',
                        resetToken: resetToken,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        success: true
                    });
                } catch (logError) {
                    console.log('Failed to log password update:', logError);
                }
                
                // Clear session storage
                sessionStorage.removeItem('resetUserId');
                sessionStorage.removeItem('resetToken');
                sessionStorage.removeItem('resetTokenTime');
                
                // Clear rate limiting
                localStorage.removeItem('resetAttempts');
                localStorage.removeItem('lastResetAttempt');
                
                showMessage('üéâ Password updated successfully! You can now login with your new password.', 'success');
                
                // Clear form fields
                document.getElementById('newPassword').value = '';
                document.getElementById('confirmNewPassword').value = '';
                
                setTimeout(() => {
                    switchToTab('login');
                }, 2000);
                
            } catch (error) {
                console.error('Reset password error:', error);
                showMessage('Failed to update password. Please try again.', 'error');
            }
            
            setLoading('reset', false);
        });

        // Real-time password validation
        document.addEventListener('DOMContentLoaded', function() {
            const newPasswordInput = document.getElementById('newPassword');
            if (newPasswordInput) {
                newPasswordInput.addEventListener('input', function() {
                    const password = this.value;
                    
                    // Check length
                    const lengthReq = document.getElementById('req-length');
                    if (lengthReq) {
                        if (password.length >= 6) {
                            lengthReq.classList.add('valid');
                        } else {
                            lengthReq.classList.remove('valid');
                        }
                    }
                    
                    // Check uppercase
                    const upperReq = document.getElementById('req-upper');
                    if (upperReq) {
                        if (/[A-Z]/.test(password)) {
                            upperReq.classList.add('valid');
                        } else {
                            upperReq.classList.remove('valid');
                        }
                    }
                    
                    // Check lowercase
                    const lowerReq = document.getElementById('req-lower');
                    if (lowerReq) {
                        if (/[a-z]/.test(password)) {
                            lowerReq.classList.add('valid');
                        } else {
                            lowerReq.classList.remove('valid');
                        }
                    }
                    
                    // Check number
                    const numberReq = document.getElementById('req-number');
                    if (numberReq) {
                        if (/\d/.test(password)) {
                            numberReq.classList.add('valid');
                        } else {
                            numberReq.classList.remove('valid');
                        }
                    }
                    
                    // Check password match
                    checkPasswordMatch();
                });
            }
        });
        
        document.addEventListener('DOMContentLoaded', function() {
            const confirmPasswordInput = document.getElementById('confirmNewPassword');
            if (confirmPasswordInput) {
                confirmPasswordInput.addEventListener('input', checkPasswordMatch);
            }
        });
        
        function checkPasswordMatch() {
            const passwordInput = document.getElementById('newPassword');
            const confirmPasswordInput = document.getElementById('confirmNewPassword');
            const matchReq = document.getElementById('req-match');
            
            if (passwordInput && confirmPasswordInput && matchReq) {
                const password = passwordInput.value;
                const confirmPassword = confirmPasswordInput.value;
                
                if (confirmPassword && password === confirmPassword) {
                    matchReq.classList.add('valid');
                } else {
                    matchReq.classList.remove('valid');
                }
            }
        }
        
        // Session timer for reset form
        let resetSessionTimer = null;
        let countdownTimer = null;
        
        function startResetSessionTimer() {
            const resetTokenTime = parseInt(sessionStorage.getItem('resetTokenTime') || '0');
            if (!resetTokenTime) return;
            
            const fifteenMinutes = 15 * 60 * 1000;
            
            function updateCountdown() {
                const timeLeft = fifteenMinutes - (Date.now() - resetTokenTime);
                
                if (timeLeft <= 0) {
                    showMessage('Reset session expired. Please verify your identity again.', 'error');
                    clearResetSessionTimer();
                    switchToTab('forgot');
                    return;
                }
                
                // Update countdown display
                const minutes = Math.floor(timeLeft / (60 * 1000));
                const seconds = Math.floor((timeLeft % (60 * 1000)) / 1000);
                const timeLeftElement = document.getElementById('timeLeft');
                if (timeLeftElement) {
                    timeLeftElement.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                    
                    // Change color based on time left
                    const sessionTimer = document.getElementById('sessionTimer');
                    if (sessionTimer) {
                        if (timeLeft <= 5 * 60 * 1000) { // 5 minutes
                            sessionTimer.style.color = '#ff4757';
                        } else if (timeLeft <= 10 * 60 * 1000) { // 10 minutes
                            sessionTimer.style.color = '#ffc107';
                        } else {
                            sessionTimer.style.color = '#2ed573';
                        }
                    }
                }
                
                // Show warning at 5 minutes left (only once)
                const fiveMinutes = 5 * 60 * 1000;
                if (timeLeft <= fiveMinutes && timeLeft > (fiveMinutes - 1000)) {
                    showMessage('‚ö†Ô∏è Session expires in 5 minutes! Please complete password reset soon.', 'error');
                }
            }
            
            // Update immediately and then every second
            updateCountdown();
            countdownTimer = setInterval(updateCountdown, 1000);
        }
        
        // Clear timer when leaving reset form
        function clearResetSessionTimer() {
            if (resetSessionTimer) {
                clearTimeout(resetSessionTimer);
                resetSessionTimer = null;
            }
            if (countdownTimer) {
                clearInterval(countdownTimer);
                countdownTimer = null;
            }
        }

        // Enter key support
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const activeForm = document.querySelector('.auth-form.active');
                if (activeForm.id === 'loginForm') {
                    document.getElementById('loginBtn').click();
                } else if (activeForm.id === 'registerForm') {
                    document.getElementById('registerBtn').click();
                } else if (activeForm.id === 'forgotForm') {
                    document.getElementById('forgotBtn').click();
                } else if (activeForm.id === 'resetForm') {
                    document.getElementById('resetBtn').click();
                }
            }
        });

        // Utility functions
        function showMessage(message, type) {
            const container = document.getElementById('messageContainer');
            container.innerHTML = `<div class="${type}-message">${message}</div>`;
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }

        function clearMessages() {
            document.getElementById('messageContainer').innerHTML = '';
        }

        function setLoading(type, loading) {
            const btn = document.getElementById(type + 'Btn');
            const text = document.getElementById(type + 'BtnText');
            const spinner = document.getElementById(type + 'Spinner');
            
            if (loading) {
                btn.disabled = true;
                text.style.display = 'none';
                spinner.style.display = 'block';
            } else {
                btn.disabled = false;
                text.style.display = 'block';
                spinner.style.display = 'none';
            }
        }

        function showUserIdSuccess(userId) {
            const container = document.getElementById('messageContainer');
            container.innerHTML = `
                <div class="user-id-display">
                    <h3>Registration Successful!</h3>
                    <p>Your User ID is:</p>
                    <div class="user-id-code">${userId}</div>
                    <button class="copy-btn" onclick="copyUserId('${userId}')">Copy User ID</button>
                    <p style="margin-top: 15px; font-size: 0.9rem; color: #cccccc;">
                        Save this ID! You'll need it to login.
                    </p>
                </div>
            `;
        }

        function copyUserId(userId) {
            navigator.clipboard.writeText(userId).then(() => {
                showMessage('User ID copied to clipboard!', 'success');
            }).catch(() => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = userId;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showMessage('User ID copied to clipboard!', 'success');
            });
        }

        // Check if user is already logged in
        document.addEventListener('DOMContentLoaded', function() {
            const userSession = localStorage.getItem('spartanUserSession');
            
            if (userSession) {
                try {
                    const session = JSON.parse(userSession);
                    if (session.timestamp > Date.now() - 24 * 60 * 60 * 1000) {
                        showMessage('You are already logged in. Redirecting...', 'success');
                        setTimeout(() => {
                            window.location.href = 'index.html';
                        }, 1500);
                        return;
                    }
                } catch (e) {
                    localStorage.removeItem('spartanUserSession');
                }
            }
        });
    </script>
</body>
</html>
